<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿåˆ—è¡¨ - ä½“è‚²æ•™å¸ˆåŠ©æ‰‹</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* æ€§åˆ«å¾½æ ‡ */
        .gender-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 12px; font-weight: 600;
        }
        .gender-male   { background: #dbeafe; color: #1d4ed8; }
        .gender-female { background: #fce7f3; color: #be185d; }

        /* é€‰ä¿®ç­å¾½æ ‡ */
        .elective-tag {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 12px; font-weight: 500;
        }
        .elective-tag.has-class  { background: #d1fae5; color: #065f46; }
        .elective-tag.no-class   { background: #f3f4f6; color: #9ca3af; }

        /* å¤´åƒåœ†åœˆ */
        .avatar-circle {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, #4a90e2, #7ec8e3);
            color: #fff; font-size: 13px; font-weight: 700;
            display: inline-flex; align-items: center; justify-content: center;
        }

        /* å­¦å·å­—ä½“ */
        .student-no-text { font-family: monospace; color: #555; font-size: 13px; }

        /* ç­çº§ç±»å‹æ ‡ç­¾ */
        .class-type-badge {
            padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;
        }
        .class-type-admin    { background: #dbeafe; color: #1e40af; }
        .class-type-elective { background: #d1fae5; color: #065f46; }

        /* æ“ä½œæŒ‰é’®é—´è· */
        .action-btns { display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; white-space: nowrap; }

        /* å¼¹çª— */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,.45); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #fff; border-radius: 12px; width: 400px;
            max-width: 95vw; box-shadow: 0 8px 32px rgba(0,0,0,.2);
            animation: modalIn .18s ease;
        }
        @keyframes modalIn {
            from { transform: translateY(-16px); opacity: 0; }
            to   { transform: translateY(0);     opacity: 1; }
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 22px; background: #4a90e2; border-radius: 12px 12px 0 0;
        }
        .modal-header h3 { font-size: 15px; color: #fff; margin: 0; }
        .modal-close {
            background: none; border: none; font-size: 22px;
            color: rgba(255,255,255,.8); cursor: pointer; line-height: 1; padding: 0 2px;
        }
        .modal-close:hover { color: #fff; }
        .modal-body { padding: 22px 22px 8px; }
        .modal-footer { padding: 12px 22px 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-student-info {
            display: flex; align-items: center; gap: 10px;
            background: #f8f9fa; border-radius: 8px; padding: 10px 14px;
            margin-bottom: 16px;
        }
        .modal-student-info .name { font-weight: 600; color: #2c3e50; font-size: 15px; }
        .modal-student-info .current { font-size: 12px; color: #888; margin-top: 2px; }
        
        /* å­¦ç”Ÿåˆ—è¡¨ç¾åŒ– */
        .student-list-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .student-card {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }
        
        .student-card:last-child {
            border-bottom: none;
        }
        
        .student-card:hover {
            background-color: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a90e2, #7ec8e3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .student-info {
            flex-grow: 1;
        }
        
        .student-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .student-details {
            display: flex;
            gap: 15px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .student-actions {
            flex-shrink: 0;
        }
        
        .card-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            font-size: 13px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }
        
        .card-btn:hover {
            background: #cbd5e0;
        }
        
        .card-btn-primary {
            background: #3498db;
            color: white;
        }
        
        .card-btn-primary:hover {
            background: #2980b9;
        }
        
        .card-btn-outline {
            background: transparent;
            border: 1px solid #cbd5e0;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .student-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 16px;
            }
            
            .student-photo {
                margin-right: 0;
                margin-bottom: 12px;
            }
            
            .student-details {
                flex-wrap: wrap;
                width: 100%;
            }
            
            .student-actions {
                width: 100%;
                margin-top: 12px;
                display: flex;
                justify-content: flex-end;
            }
            
            .card-btn {
                margin-left: 6px;
                padding: 5px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-brand">ğŸƒ ä½“è‚²æ•™å¸ˆåŠ©æ‰‹</div>
    <div class="nav-links">
        <a th:href="@{/dashboard}">é¦–é¡µ</a>
        <span class="nav-user" th:if="${currentSchool != null}" th:text="${currentSchool.name}"></span>
        <form th:action="@{/logout}" method="post" style="display:inline">
            <button type="submit" class="btn-link">é€€å‡º</button>
        </form>
    </div>
</nav>

<div class="container">
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h2 th:text="${(schoolClass.grade != null ? schoolClass.grade.name + ' ' : '') + schoolClass.name}"></h2>
        <span class="class-type-badge"
              th:classappend="${'é€‰ä¿®è¯¾'.equals(schoolClass.type)} ? 'class-type-elective' : 'class-type-admin'"
              th:text="${schoolClass.type}"></span>
        <span style="flex:1"></span>
        <a th:href="@{/attendance/class/{id}(id=${schoolClass.id})}" class="btn btn-primary">å»è€ƒå‹¤</a>
        <a th:href="@{/dashboard}" class="btn btn-outline">è¿”å›é¦–é¡µ</a>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row" style="flex-wrap:nowrap">
        <div class="stat-card total">
            <span class="stat-num" th:text="${#lists.size(students)}">0</span><span class="stat-label"> æ€»äººæ•°</span>
        </div>
        <div class="stat-card present">
            <span class="stat-num" th:text="${withElectiveCount}">0</span><span class="stat-label"> å·²é€‰è¯¾</span>
        </div>
        <div class="stat-card absent">
            <span class="stat-num" th:text="${noElectiveCount}">0</span><span class="stat-label"> æœªé€‰è¯¾</span>
        </div>
    </div>


    <!-- å­¦ç”Ÿå¡ç‰‡åˆ—è¡¨ -->
    <div class="student-list-container">
        <div th:each="s, iter : ${students}" class="student-card">
            <!-- å¤´åƒ -->
            <div class="student-photo" th:text="${s.name.charAt(0)}"></div>

            <!-- å­¦ç”Ÿä¿¡æ¯ -->
            <div class="student-info">
                <div class="student-name">
                    <span th:text="${s.name}"></span>
                    <span class="gender-badge"
                          th:classappend="${'ç”·'.equals(s.gender)} ? 'gender-male' : 'gender-female'"
                          style="margin-left:8px"
                          th:text="${s.gender ?: '-'}"></span>
                </div>
                <div class="student-details">
                    <span class="detail-item">
                        <span style="color:#9ca3af;font-size:12px">å­¦å·</span>
                        <span class="student-no-text" th:text="${s.studentNo ?: '-'}"></span>
                    </span>
                    <span class="detail-item">
                        <span th:if="${s.electiveClass != null}"
                              class="elective-tag has-class"
                              th:text="${s.electiveClass}"></span>
                        <span th:unless="${s.electiveClass != null}"
                              class="elective-tag no-class">æœªé€‰è¯¾</span>
                    </span>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="student-actions">
                <a th:href="@{/attendance/student/{id}(id=${s.id})}"
                   class="card-btn card-btn-primary">è€ƒå‹¤è®°å½•</a>
                <button type="button" class="card-btn card-btn-outline"
                        th:data-id="${s.id}"
                        th:data-name="${s.name}"
                        th:data-elective="${s.electiveClass}"
                        onclick="openElectiveModal(this)">
                    ä¿®æ”¹é€‰ä¿®ç­
                </button>
                <button type="button" class="card-btn card-btn-outline"
                        th:data-id="${s.id}"
                        th:data-name="${s.name}"
                        th:data-classid="${s.schoolClass != null ? s.schoolClass.id : ''}"
                        th:data-classname="${s.schoolClass != null ? (s.schoolClass.grade != null ? s.schoolClass.grade.name + ' ' : '') + s.schoolClass.name : 'æœªåˆ†é…'}"
                        th:data-gradeid="${s.schoolClass != null and s.schoolClass.grade != null ? s.schoolClass.grade.id : ''}"
                        onclick="openClassModal(this)">
                    ä¿®æ”¹ç­çº§
                </button>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(students)}"
             style="padding:40px;text-align:center;color:#9ca3af;font-size:14px">
            æš‚æ— å­¦ç”Ÿæ•°æ®
        </div>
    </div>
</div>

<!-- ä¿®æ”¹é€‰ä¿®ç­å¼¹çª— -->
<div id="electiveModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>ä¿®æ”¹é€‰ä¿®ç­</h3>
            <button class="modal-close" onclick="closeElectiveModal()">Ã—</button>
        </div>
        <form id="electiveForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="hidden" name="classId" th:value="${schoolClass.id}">
            <div class="modal-body">
                <div class="modal-student-info">
                    <div class="avatar-circle" id="modalAvatar">?</div>
                    <div>
                        <div class="name" id="modalStudentName"></div>
                        <div class="current">å½“å‰é€‰ä¿®ç­ï¼š<span id="modalCurrentElective">æœªé€‰è¯¾</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ–°çš„é€‰ä¿®ç­</label>
                    <select name="electiveClass" id="electiveSelect">
                        <option value="">â€” ä¸å‚åŠ é€‰ä¿® â€”</option>
                        <option th:each="ec : ${electiveClasses}"
                                th:value="${(ec.grade != null ? ec.grade.name + '/' : '') + ec.name}"
                                th:text="${(ec.grade != null ? ec.grade.name + '/' : '') + ec.name}"></option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeElectiveModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<!-- ä¿®æ”¹ç­çº§å¼¹çª— -->
<div id="classModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>ä¿®æ”¹ç­çº§</h3>
            <button class="modal-close" onclick="closeClassModal()">Ã—</button>
        </div>
        <form id="classForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="hidden" name="classId" th:value="${schoolClass.id}">
            <div class="modal-body">
                <div class="modal-student-info">
                    <div class="avatar-circle" id="classModalAvatar">?</div>
                    <div>
                        <div class="name" id="classModalStudentName"></div>
                        <div class="current">å½“å‰ç­çº§ï¼š<span id="classModalCurrent"></span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ–°çš„ç­çº§</label>
                    <select name="newClassId" id="classSelect">
                        <option th:each="ac : ${adminClasses}"
                                th:value="${ac.id}"
                                th:data-gradeid="${ac.grade != null ? ac.grade.id : ''}"
                                th:text="${(ac.grade != null ? ac.grade.name + ' ' : '') + ac.name}"></option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeClassModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openElectiveModal(btn) {
        var studentId   = btn.dataset.id;
        var studentName = btn.dataset.name;
        var current     = btn.dataset.elective || '';
        document.getElementById('modalStudentName').textContent = studentName;
        document.getElementById('modalAvatar').textContent = studentName.charAt(0);
        document.getElementById('modalCurrentElective').textContent = current || 'æœªé€‰è¯¾';
        document.getElementById('electiveForm').action = '/teacher/students/' + studentId + '/elective';
        var sel = document.getElementById('electiveSelect');
        sel.value = current;
        document.getElementById('electiveModal').classList.add('active');
    }
    function closeElectiveModal() {
        document.getElementById('electiveModal').classList.remove('active');
    }
    document.getElementById('electiveModal').addEventListener('click', function(e) {
        if (e.target === this) closeElectiveModal();
    });

    function openClassModal(btn) {
        var studentId   = btn.dataset.id;
        var studentName = btn.dataset.name;
        var curClassId  = btn.dataset.classid;
        var curClassName= btn.dataset.classname;
        var gradeId     = btn.dataset.gradeid;
        document.getElementById('classModalStudentName').textContent = studentName;
        document.getElementById('classModalAvatar').textContent = studentName.charAt(0);
        document.getElementById('classModalCurrent').textContent = curClassName;
        document.getElementById('classForm').action = '/teacher/students/' + studentId + '/class';
        // æŒ‰å¹´çº§è¿‡æ»¤é€‰é¡¹
        var sel = document.getElementById('classSelect');
        Array.from(sel.options).forEach(function(opt) {
            opt.hidden = gradeId ? opt.dataset.gradeid !== gradeId : false;
        });
        if (curClassId) sel.value = curClassId;
        document.getElementById('classModal').classList.add('active');
    }
    function closeClassModal() {
        document.getElementById('classModal').classList.remove('active');
    }
    document.getElementById('classModal').addEventListener('click', function(e) {
        if (e.target === this) closeClassModal();
    });
</script>

<footer class="site-footer">
    <th:block th:replace="~{fragments/footer :: version}"></th:block>
    <span class="footer-sep">|</span>
    <span>Â© 2026 é™ˆèƒœæ¾ ç‰ˆæƒæ‰€æœ‰</span>
</footer>
</body>
</html>
