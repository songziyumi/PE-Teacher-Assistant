<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿåˆ—è¡¨ - ä½“è‚²æ•™å¸ˆåŠ©æ‰‹</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* æ€§åˆ«å¾½æ ‡ */
        .gender-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 12px; font-weight: 600;
        }
        .gender-male   { background: #dbeafe; color: #1d4ed8; }
        .gender-female { background: #fce7f3; color: #be185d; }

        /* é€‰ä¿®ç­å¾½æ ‡ */
        .elective-tag {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 12px; font-weight: 500;
        }
        .elective-tag.has-class  { background: #d1fae5; color: #065f46; }
        .elective-tag.no-class   { background: #f3f4f6; color: #9ca3af; }

        /* å¤´åƒåœ†åœˆ */
        .avatar-circle {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, #4a90e2, #7ec8e3);
            color: #fff; font-size: 13px; font-weight: 700;
            display: inline-flex; align-items: center; justify-content: center;
        }

        /* å­¦å·å­—ä½“ */
        .student-no-text { font-family: monospace; color: #555; font-size: 13px; }

        /* ç­çº§ç±»å‹æ ‡ç­¾ */
        .class-type-badge {
            padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600;
        }
        .class-type-admin    { background: #dbeafe; color: #1e40af; }
        .class-type-elective { background: #d1fae5; color: #065f46; }

        /* æ“ä½œæŒ‰é’®é—´è· */
        .action-btns { display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; white-space: nowrap; }

        /* å¼¹çª— */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,.45); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #fff; border-radius: 12px; width: 400px;
            max-width: 95vw; box-shadow: 0 8px 32px rgba(0,0,0,.2);
            animation: modalIn .18s ease;
        }
        @keyframes modalIn {
            from { transform: translateY(-16px); opacity: 0; }
            to   { transform: translateY(0);     opacity: 1; }
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 22px; background: #4a90e2; border-radius: 12px 12px 0 0;
        }
        .modal-header h3 { font-size: 15px; color: #fff; margin: 0; }
        .modal-close {
            background: none; border: none; font-size: 22px;
            color: rgba(255,255,255,.8); cursor: pointer; line-height: 1; padding: 0 2px;
        }
        .modal-close:hover { color: #fff; }
        .modal-body { padding: 22px 22px 8px; }
        .modal-footer { padding: 12px 22px 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .modal-student-info {
            display: flex; align-items: center; gap: 10px;
            background: #f8f9fa; border-radius: 8px; padding: 10px 14px;
            margin-bottom: 16px;
        }
        .modal-student-info .name { font-weight: 600; color: #2c3e50; font-size: 15px; }
        .modal-student-info .current { font-size: 12px; color: #888; margin-top: 2px; }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-brand">ğŸƒ ä½“è‚²æ•™å¸ˆåŠ©æ‰‹</div>
    <div class="nav-links">
        <a th:href="@{/dashboard}">é¦–é¡µ</a>
        <span class="nav-user" th:if="${currentSchool != null}" th:text="${currentSchool.name}"></span>
        <form th:action="@{/logout}" method="post" style="display:inline">
            <button type="submit" class="btn-link">é€€å‡º</button>
        </form>
    </div>
</nav>

<div class="container">
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h2 th:text="${(schoolClass.grade != null ? schoolClass.grade.name + ' ' : '') + schoolClass.name}"></h2>
        <span class="class-type-badge"
              th:classappend="${'é€‰ä¿®è¯¾'.equals(schoolClass.type)} ? 'class-type-elective' : 'class-type-admin'"
              th:text="${schoolClass.type}"></span>
        <span style="flex:1"></span>
        <a th:href="@{/attendance/class/{id}(id=${schoolClass.id})}" class="btn btn-primary">å»è€ƒå‹¤</a>
        <a th:href="@{/dashboard}" class="btn btn-outline">è¿”å›é¦–é¡µ</a>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row" style="flex-wrap:nowrap">
        <div class="stat-card total">
            <span class="stat-num" th:text="${#lists.size(students)}">0</span><span class="stat-label"> æ€»äººæ•°</span>
        </div>
        <div class="stat-card present">
            <span class="stat-num" th:text="${withElectiveCount}">0</span><span class="stat-label"> å·²é€‰è¯¾</span>
        </div>
        <div class="stat-card absent">
            <span class="stat-num" th:text="${noElectiveCount}">0</span><span class="stat-label"> æœªé€‰è¯¾</span>
        </div>
    </div>

    <!-- å­¦ç”Ÿè¡¨æ ¼ -->
    <table class="table">
        <thead>
            <tr>
                <th style="width:48px">åºå·</th>
                <th>å§“å</th>
                <th style="width:60px">æ€§åˆ«</th>
                <th>å­¦å·</th>
                <th>é€‰ä¿®ç­</th>
                <th style="width:190px">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="s, iter : ${students}">
                <td>
                    <div class="avatar-circle" th:text="${iter.count}"></div>
                </td>
                <td>
                    <span style="font-weight:500;color:#2c3e50" th:text="${s.name}"></span>
                </td>
                <td>
                    <span class="gender-badge"
                          th:classappend="${'ç”·'.equals(s.gender)} ? 'gender-male' : 'gender-female'"
                          th:text="${s.gender ?: '-'}"></span>
                </td>
                <td>
                    <span class="student-no-text" th:text="${s.studentNo ?: '-'}"></span>
                </td>
                <td>
                    <span th:if="${s.electiveClass != null}"
                          class="elective-tag has-class"
                          th:text="${s.electiveClass}"></span>
                    <span th:unless="${s.electiveClass != null}"
                          class="elective-tag no-class">æœªé€‰è¯¾</span>
                </td>
                <td>
                    <div class="action-btns">
                        <a th:href="@{/attendance/student/{id}(id=${s.id})}"
                           class="btn btn-sm btn-primary">è€ƒå‹¤è®°å½•</a>
                        <button type="button" class="btn btn-sm btn-outline"
                                th:data-id="${s.id}"
                                th:data-name="${s.name}"
                                th:data-elective="${s.electiveClass}"
                                onclick="openElectiveModal(this)">
                            ä¿®æ”¹é€‰ä¿®ç­
                        </button>
                    </div>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(students)}">
                <td colspan="6" class="empty-state">æš‚æ— å­¦ç”Ÿæ•°æ®</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- ä¿®æ”¹é€‰ä¿®ç­å¼¹çª— -->
<div id="electiveModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>ä¿®æ”¹é€‰ä¿®ç­</h3>
            <button class="modal-close" onclick="closeElectiveModal()">Ã—</button>
        </div>
        <form id="electiveForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="hidden" name="classId" th:value="${schoolClass.id}">
            <div class="modal-body">
                <div class="modal-student-info">
                    <div class="avatar-circle" id="modalAvatar">?</div>
                    <div>
                        <div class="name" id="modalStudentName"></div>
                        <div class="current">å½“å‰é€‰ä¿®ç­ï¼š<span id="modalCurrentElective">æœªé€‰è¯¾</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ–°çš„é€‰ä¿®ç­</label>
                    <select name="electiveClass" id="electiveSelect">
                        <option value="">â€” ä¸å‚åŠ é€‰ä¿® â€”</option>
                        <option th:each="ec : ${electiveClasses}"
                                th:value="${(ec.grade != null ? ec.grade.name + '/' : '') + ec.name}"
                                th:text="${(ec.grade != null ? ec.grade.name + '/' : '') + ec.name}"></option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeElectiveModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openElectiveModal(btn) {
        var studentId   = btn.dataset.id;
        var studentName = btn.dataset.name;
        var current     = btn.dataset.elective || '';
        document.getElementById('modalStudentName').textContent = studentName;
        document.getElementById('modalAvatar').textContent = studentName.charAt(0);
        document.getElementById('modalCurrentElective').textContent = current || 'æœªé€‰è¯¾';
        document.getElementById('electiveForm').action = '/teacher/students/' + studentId + '/elective';
        var sel = document.getElementById('electiveSelect');
        sel.value = current;
        document.getElementById('electiveModal').classList.add('active');
    }
    function closeElectiveModal() {
        document.getElementById('electiveModal').classList.remove('active');
    }
    document.getElementById('electiveModal').addEventListener('click', function(e) {
        if (e.target === this) closeElectiveModal();
    });
</script>

<footer class="site-footer">
    <th:block th:replace="~{fragments/footer :: version}"></th:block>
    <span class="footer-sep">|</span>
    <span>Â© 2026 é™ˆèƒœæ¾ ç‰ˆæƒæ‰€æœ‰</span>
</footer>
</body>
</html>
